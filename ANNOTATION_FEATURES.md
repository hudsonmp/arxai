# PDF Annotation Features

## Overview

The ArXai system now includes enhanced PDF annotation capabilities that add both **visual highlights** and **collapsible comments** to child papers, explaining how each highlighted section relates to the parent paper. Additionally, each annotated PDF displays a **bold relevance score** at the top of the first page.

## Key Features

### 1. Collapsible Comments on Highlights

Every highlighted section in a child paper now includes a collapsible PDF comment that explains:
- How the highlighted content relates to the parent paper
- The type of relationship (similar methodology, contradictory findings, extends the work, etc.)
- Why this connection is significant

**How it works:**
- Click on any yellow highlight in the PDF
- A comment popup will appear with the relationship explanation
- Comments are generated by Claude analyzing both the child and parent papers

### 2. Relevance Score Header

Each annotated PDF displays the paper's relevance score at the top of the first page:
- **Format:** "Relevance to '[Parent Paper Title]': 0.XXXX"
- **Styling:** Bold font with yellow background for visibility
- **Position:** Centered at the top of the first page

This allows you to immediately see how relevant each paper is without checking external metadata.

### 3. Context-Aware Highlighting

The highlighting system now understands the parent paper's context:
- Highlights focus on sections that relate to the parent paper's themes
- Claude identifies connections across:
  - Methodological similarities
  - Contradictory findings
  - Extensions of the parent work
  - Related problem domains
  - Shared applications

## Technical Implementation

### Updated Components

#### 1. `arxiv_annotator.py`
- **`HIGHLIGHT_PROMPT`**: Enhanced to include parent paper context
- **`get_highlight_suggestions()`**: Accepts parent_title and parent_abstract parameters
- **`add_relevance_score_header()`**: New function to add score banner
- **`add_highlight_to_pdf()`**: Enhanced to add collapsible comments via `set_info()`
- **`annotate_pdf()`**: Orchestrates both highlights and comments, adds score header

#### 2. `algo.py`
- **`Paper` class**: Added `abstract` field to support parent paper context

#### 3. `orchestrator.py`
- Now uses `arxiv_annotator.process_multiple_papers()` instead of `pdf_processor`
- Passes parent paper title and abstract to each child paper for annotation

#### 4. `direct_ranking.py`
- Already passes parent paper context to annotation pipeline

### Data Flow

```
Parent Paper (PDF) 
    ↓
Extract Title + Abstract
    ↓
Child Papers from Algorithm
    ↓
For each child paper:
    1. Download PDF
    2. Extract text page-by-page
    3. Claude analyzes with parent context
    4. Generates highlights + relationship explanations
    5. Adds score header to first page
    6. Adds highlights with comments to PDF
    7. Saves annotated PDF
    ↓
Upload to Supabase Storage
```

## Usage

### Running the Annotation Pipeline

**Option 1: Via Direct Ranking (Recommended)**
```bash
python direct_ranking.py
```
This will:
- Load all papers from Pinecone
- Rank them by similarity + citations
- Annotate top 15 with highlights, comments, and scores
- Upload to Supabase storage

**Option 2: Via Full Orchestrator**
```bash
python orchestrator.py
```
This will:
- Run the full bidirectional algorithm
- Perform quality research
- Annotate top 5 papers with all features
- Store in Supabase

### Output Format

Each paper generates two files:
- `{paper_id}_original.pdf` - Original downloaded PDF
- `{paper_id}_annotated.pdf` - PDF with highlights, comments, and score

**Annotation Statistics:**
- Total highlights added
- Total comments added
- Pages annotated
- Average highlights per paper
- Average comments per paper

## Example Comment

**Highlighted Text:**
> "We employ a transformer-based architecture with attention mechanisms for sequence modeling."

**Comment:**
> "This methodology directly parallels the parent paper's approach to neural architecture design. Both papers utilize transformer architectures, though this work applies them to a different domain (NLP vs. computer vision). The attention mechanism serves a similar purpose in capturing long-range dependencies, suggesting this paper could provide valuable insights into architectural choices."

## PDF Viewer Compatibility

The annotation features use standard PDF annotation formats and should work with:
- ✅ Adobe Acrobat Reader
- ✅ Mac Preview
- ✅ Chrome/Firefox PDF viewer
- ✅ Most modern PDF viewers

**Note:** Some lightweight PDF viewers may not display comments. Use Adobe Reader or Preview for full functionality.

## Configuration

Key parameters in `arxiv_annotator.py`:

```python
# Annotation parameters
max_pages = 20  # Maximum pages to annotate per paper
max_concurrent = 3  # Concurrent papers to process

# Score header position
text_rect = fitz.Rect(50, 10, page_rect.width - 50, 50)  # Top center

# Comment author
highlight.set_info(title="ArXai Analysis")  # Appears as comment author
```

## Troubleshooting

### Comments not appearing
- Ensure your PDF viewer supports annotations
- Try opening in Adobe Acrobat Reader
- Check that `comment_text` is being passed to `add_highlight_to_pdf()`

### Score header overlapping text
- Adjust `text_rect` position in `add_relevance_score_header()`
- Reduce font size if needed

### Missing parent paper context
- Ensure parent paper has abstract in Pinecone metadata
- Check that `parent_title` and `parent_abstract` are passed to `annotate_pdf()`
- Verify Paper class has `abstract` attribute

## Future Enhancements

Potential improvements:
- [ ] Multi-level comment threads
- [ ] Color-coded highlights by relationship type
- [ ] Summary comment on first page with all key connections
- [ ] Export comments to separate JSON for analysis
- [ ] Interactive web viewer for annotations

## API Reference

### Main Functions

#### `add_relevance_score_header(page, relevance_score, parent_title=None)`
Adds a bold text box with relevance score to the page.

**Parameters:**
- `page` (fitz.Page): PDF page object
- `relevance_score` (float): Relevance score from algorithm
- `parent_title` (str, optional): Parent paper title for context

#### `add_highlight_to_pdf(page, text_to_highlight, priority=2, comment_text=None)`
Adds a colored highlight with optional collapsible comment.

**Parameters:**
- `page` (fitz.Page): PDF page object
- `text_to_highlight` (str): Exact text to highlight
- `priority` (int): 1=critical, 2=important, 3=relevant
- `comment_text` (str, optional): Comment explaining relationship to parent

#### `annotate_pdf(pdf_path, output_path, title, parent_title="", parent_abstract="", relevance_score=0.0, max_pages=20)`
Complete annotation pipeline with highlights, comments, and score header.

**Returns:**
- Dict with status, total_highlights, total_comments, pages_annotated

## See Also

- `STORAGE_SETUP.md` - Supabase storage configuration
- `USAGE.md` - General usage instructions
- `algorithm.md` - Ranking algorithm details

